# BEAM_INSERTBEAMMCSTOP

**Procedure Number**: 041 | **Module**: M03 - Beaming | **Status**: âœ… ANALYZED

---

## Quick Reference

| Attribute | Value |
|-----------|-------|
| **Purpose** | Record machine stop event during beam production |
| **Operation** | INSERT |
| **Tables** | tblBeamingMCStop |
| **Called From** | BeamingDataService.cs:1260 â†’ BEAM_INSERTBEAMMCSTOP() |
| **Frequency** | Medium |
| **Performance** | Fast |
| **Issues** | ðŸŸ¢ None |

---

## Parameters

### Input (IN)

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `P_BEAMERNO` | VARCHAR2(50) | âœ… | Beamer setup/batch number |
| `P_BEAMLOT` | VARCHAR2(50) | âœ… | Beam roll lot number (barcode) |
| `P_REASON` | VARCHAR2(100) | âœ… | Stop reason code/description |
| `P_LENGTH` | NUMBER | â¬œ | Length at which machine stopped (meters) |
| `P_OTHER` | VARCHAR2(200) | â¬œ | Additional notes if "Other" reason selected |
| `P_OPERATOR` | VARCHAR2(50) | âœ… | Operator recording the stop |

### Output (OUT)

| Parameter | Type | Description |
|-----------|------|-------------|
| `R_RESULT` | VARCHAR2 | Result message (success/error) |

### Returns

| Type | Description |
|------|-------------|
| `String` | Result message from database |

---

## Database Operations

### Tables

**Primary Tables**:
- `tblBeamingMCStop` - INSERT - Records machine stop event

**Transaction**: Optional (single record insert, but should be part of production transaction)

### Indexes (if relevant)

```sql
-- Recommended composite index for retrieving stop history
CREATE INDEX idx_beamingmcstop_beamerno_lot ON tblBeamingMCStop(BEAMERNO, BEAMLOT);

-- Also useful for downtime analysis reports
CREATE INDEX idx_beamingmcstop_createdate ON tblBeamingMCStop(CREATEDATE);
CREATE INDEX idx_beamingmcstop_reason ON tblBeamingMCStop(REASON);
```

---

## Database Operations

### Tables

**Primary Tables**:
- `tblBeamingMCStop` - INSERT - Records stop event with timestamp

**Transaction**: No (independent stop event logging)

---

## Business Logic (What it does and why)

Records machine stop event during beam production for downtime tracking, quality analysis, and performance metrics.

**Purpose**: When beaming machine stops during production (breakdown, yarn break, maintenance, etc.), operator records:
- Why it stopped (reason code)
- Where it stopped (at what length)
- Any additional notes

This data is critical for:
- **Downtime Analysis**: Calculate OEE (Overall Equipment Effectiveness)
- **Quality Investigation**: Stops may correlate with fabric defects later
- **Performance Metrics**: Track stop frequency and causes
- **Maintenance Planning**: Identify recurring breakdown patterns

**When Used**:
- **During Production**: Machine stops unexpectedly or planned
- **Operator Action**: Clicks "Record Stop" button, selects reason, enters notes
- **Multiple Stops**: Can be called multiple times per beam lot
- **Real-Time Logging**: Timestamp auto-captured at time of recording

**Business Rules**:
- All required parameters must be provided (BEAMERNO, BEAMLOT, REASON, OPERATOR)
- P_LENGTH is optional (operator may not know exact length)
- P_OTHER is required if REASON="Other" (OTHERFLAG set in database)
- Empty/null BEAMERNO causes failure (returns empty string)
- CREATEDATE auto-generated by database (current timestamp)
- Multiple stop events can exist for same BEAMLOT (sequential stops)

**Data Flow**:
1. Machine stops during beam production
2. Operator clicks "Record Stop" button on production screen
3. UI displays stop reason dropdown (Yarn Break, Mechanical, Power, Other, etc.)
4. Operator selects reason and optionally enters:
   - Current length (if known)
   - Additional notes (if "Other" reason)
5. System calls this procedure to log the event
6. Database captures timestamp automatically
7. Later: BEAM_GETSTOPREASONBYBEAMLOT retrieves all stops for analysis

**Stop Reason Categories** (typical):
- Yarn Break
- Mechanical Breakdown
- Electrical/Power Issue
- Tension Problem
- Operator Break/Changeover
- Quality Check
- Other (requires notes)

---

## Related Procedures

**Upstream**:
- [040-BEAM_INSERTBEAMINGDETAIL.md](./040-BEAM_INSERTBEAMINGDETAIL.md) - Starts beam production (creates BEAMLOT)
- [033-BEAM_GETBEAMROLLDETAIL.md](./033-BEAM_GETBEAMROLLDETAIL.md) - Gets beam details before recording stop

**Downstream**:
- [036-BEAM_GETSTOPREASONBYBEAMLOT.md](./036-BEAM_GETSTOPREASONBYBEAMLOT.md) - Retrieves stop history

**Similar**:
- [018-WARP_INSERTWARPMCSTOP.md](../02_Warping/018-WARP_INSERTWARPMCSTOP.md) - Warping module equivalent
- [WEAV_INSERTMCSTOP.md](../05_Weaving/WEAV_INSERTMCSTOP.md) - Weaving module equivalent

---

## Query/Code Location

**Note**: This project does NOT use stored procedures in the database. Queries are hardcoded in C# DataService classes.

**File**: `BeamingDataService.cs`
**Method**: `BEAM_INSERTBEAMMCSTOP()`
**Line**: 1258-1294

**Query Type**: INSERT via DatabaseManager wrapper

```csharp
// Method signature
public string BEAM_INSERTBEAMMCSTOP(
    string P_BEAMERNO,
    string P_BEAMLOT,
    string P_REASON,
    decimal? P_LENGTH,
    string P_OTHER,
    string P_OPERATOR)
{
    string result = string.Empty;

    // Input validation - BEAMERNO required
    if (string.IsNullOrWhiteSpace(P_BEAMERNO))
        return result; // Returns empty string

    if (!HasConnection())
        return result;

    // Parameter setup
    BEAM_INSERTBEAMMCSTOPParameter dbPara = new BEAM_INSERTBEAMMCSTOPParameter();
    dbPara.P_BEAMERNO = P_BEAMERNO;
    dbPara.P_BEAMLOT = P_BEAMLOT;
    dbPara.P_REASON = P_REASON;
    dbPara.P_LENGTH = P_LENGTH;
    dbPara.P_OTHER = P_OTHER;
    dbPara.P_OPERATOR = P_OPERATOR;

    // Execute insert
    dbResult = DatabaseManager.Instance.BEAM_INSERTBEAMMCSTOP(dbPara);

    result = dbResult.R_RESULT; // Returns success/error message

    return result;
}
```

**Usage Pattern**:
```csharp
// In UI code-behind (BeamingProductionPage.xaml.cs)
private void btnRecordStop_Click(object sender, RoutedEventArgs e)
{
    string reason = cboStopReason.SelectedValue.ToString();
    decimal? length = string.IsNullOrEmpty(txtLength.Text)
        ? null
        : decimal.Parse(txtLength.Text);
    string other = (reason == "Other") ? txtOtherReason.Text : null;

    string result = BeamingDataService.Instance.BEAM_INSERTBEAMMCSTOP(
        currentBeamerNo,
        currentBeamLot,
        reason,
        length,
        other,
        currentOperatorID
    );

    if (!string.IsNullOrEmpty(result))
    {
        MessageBox.Show("Stop recorded successfully");
        RefreshStopHistory(); // Reload stop list
    }
}
```

---

**File**: 41/296 | **Progress**: 13.9%
