# D365_FN_OPH

**Procedure Number**: 251 | **Module**: M19 - D365 Integration | **Status**: âœ… ANALYZED

---

## Quick Reference

| Attribute | Value |
|-----------|-------|
| **Purpose** | Get Finishing Output Header for D365 ERP production output sync |
| **Operation** | SELECT |
| **Tables** | Finishing production output header table |
| **Called From** | D365DataService.cs |
| **Frequency** | High (ERP sync) |
| **Performance** | Fast |
| **Issues** | ðŸŸ¢ None identified |

---

## Parameters

### Input (IN)

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `P_FINISHINGLOT` | VARCHAR2(50) | âœ… | Finishing lot number (production identifier) |
| `P_WEAVINGLOT` | VARCHAR2(50) | âœ… | Weaving lot number (source fabric identifier) |
| `P_PROCESS` | VARCHAR2(50) | âœ… | Finishing process type (COATING/SCOURING/DRYER) |

### Returns (Cursor)

| Column | Type | Description |
|--------|------|-------------|
| `HEADERID` | NUMBER | Output header ID |
| `TOTALRECORD` | NUMBER | Total number of output line records |
| `MACHINESTART` | DATE | Machine start timestamp |

---

## Business Logic (What it does and why)

Retrieves Finishing production Output Header data for D365 ERP synchronization. Output Header represents the summary of all production output (finished fabric produced) for this finishing production lot and process. The header must be synced to D365 before individual output lines (OPL).

The procedure:
1. Takes finishing lot, weaving lot, and process type to identify the production
2. Returns output header ID for this production and process
3. Provides total count of output line items (fabric rolls)
4. Includes machine start time for production tracking
5. Header synced first, then lines (OPL) are synced with this header ID

**Note**: Each finishing process (coating, scouring, drying) produces output that must be tracked separately in D365 for proper inventory and quality control.

Part of D365 integration pattern: BPO â†’ ISH/ISL â†’ **OPH** â†’ OPL

---

## Related Procedures

**Upstream**:
- [248-D365_FN_BPO.md](./248-D365_FN_BPO.md) - Batch production order
- [249-D365_FN_ISH.md](./249-D365_FN_ISH.md) - Issue header
- [250-D365_FN_ISL.md](./250-D365_FN_ISL.md) - Issue lines

**Downstream**:
- [252-D365_FN_OPL.md](./252-D365_FN_OPL.md) - Output lines (production detail)

---

## Query/Code Location

**DataService File**: `LuckyTex.AirBag.Core\\Services\\DataService\\D365DataService.cs`

**Database Manager File**: `LuckyTex.AirBag.Core\\Domains\\AirbagSPs.cs`
**Method**: `D365_FN_OPH(D365_FN_OPHParameter para)`
**Lines**: 34175-34216

---

**File**: 251/296 | **Progress**: 84.8%
