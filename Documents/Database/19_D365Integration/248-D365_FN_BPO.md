# D365_FN_BPO

**Procedure Number**: 248 | **Module**: M19 - D365 Integration | **Status**: âœ… ANALYZED

---

## Quick Reference

| Attribute | Value |
|-----------|-------|
| **Purpose** | Get Finishing Batch Production Order data for D365 ERP sync |
| **Operation** | SELECT |
| **Tables** | Finishing production order table |
| **Called From** | D365DataService.cs |
| **Frequency** | High (ERP sync) |
| **Performance** | Fast |
| **Issues** | ðŸŸ¢ None identified |

---

## Parameters

### Input (IN)

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `P_FINISHINGLOT` | VARCHAR2(50) | âœ… | Finishing lot number (production identifier) |
| `P_WEAVINGLOT` | VARCHAR2(50) | âœ… | Weaving lot number (source fabric identifier) |
| `P_PROCESS` | VARCHAR2(50) | âœ… | Finishing process type (COATING/SCOURING/DRYER) |

### Returns (Cursor)

| Column | Type | Description |
|--------|------|-------------|
| `PRODID` | NUMBER | Production order ID in D365 |
| `LOTNO` | VARCHAR2(50) | Lot number (batch identifier) |
| `ITEMID` | VARCHAR2(50) | Item ID (finished fabric) in D365 ERP |
| `LOADINGTYPE` | VARCHAR2(50) | Loading type code |
| `QTY` | NUMBER | Quantity produced (fabric length) |
| `UNIT` | VARCHAR2(50) | Unit of measure (e.g., 'M' for meters) |
| `OPERATION` | VARCHAR2(50) | Operation code (e.g., 'FINISH') |
| `MACHINESTART` | DATE | Machine start timestamp |

---

## Business Logic (What it does and why)

Retrieves Finishing Batch Production Order data for D365 ERP synchronization. The Batch Production Order (BPO) is the foundational transaction that creates a production order in D365 for finishing operations. Finishing includes multiple processes: coating (applying chemicals), scouring (cleaning), and drying. Each process is tracked separately.

The procedure:
1. Takes finishing lot, weaving lot, and process type to identify the production
2. Returns production order details for D365 sync
3. Includes item code (finished fabric type), quantity, operation type
4. Provides machine start time for production tracking
5. Must be synced FIRST before any material consumption (ISH/ISL) or output (OPH/OPL) transactions

**Note**: Finishing procedures use 3 input parameters (finishing lot + weaving lot + process) because finishing has multiple sequential processes on the same fabric, each requiring separate D365 tracking.

Part of the D365 integration pattern: BPO â†’ ISH/ISL â†’ OPH/OPL â†’ OUH/OUL

---

## Related Procedures

**Downstream**:
- [249-D365_FN_ISH.md](./249-D365_FN_ISH.md) - Material consumption header
- [250-D365_FN_ISL.md](./250-D365_FN_ISL.md) - Material consumption lines
- [251-D365_FN_OPH.md](./251-D365_FN_OPH.md) - Production output header
- [252-D365_FN_OPL.md](./252-D365_FN_OPL.md) - Production output lines

**Similar**:
- [220-D365_WP_BPO.md](./220-D365_WP_BPO.md) - Warping BPO
- [227-D365_BM_BPO.md](./227-D365_BM_BPO.md) - Beaming BPO
- [234-D365_DT_BPO.md](./234-D365_DT_BPO.md) - Drawing BPO
- [241-D365_GR_BPO.md](./241-D365_GR_BPO.md) - Weaving BPO

---

## Query/Code Location

**DataService File**: `LuckyTex.AirBag.Core\\Services\\DataService\\D365DataService.cs`

**Database Manager File**: `LuckyTex.AirBag.Core\\Domains\\AirbagSPs.cs`
**Method**: `D365_FN_BPO(D365_FN_BPOParameter para)`
**Lines**: 34021-34068

---

**File**: 248/296 | **Progress**: 83.8%
